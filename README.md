# sample-openliberty

Experiments with OpenLiberty and Docker, featuring:

- Static web content
- Dynamic web content using JAX-RS and Thymeleaf
- REST endpoints using JAX-RS 
- H2 database using JPA and EclipseLink

## Run Standalone

~~~
$ mvn clean verify
$ export APP_SAMPLE_CONFIG=ValueFromShell
$ mvn liberty:run
~~~

For additional configuration properties, see `<bootstrapProperties>` in `pom.xml`

## Run with Docker

~~~
$ mvn clean verify -P docker
$ docker run -it --name sample-openliberty --rm \
  -p 8080:8080 \
  -p 8443:8443 \
  -e APP_JDBC_URL=jdbc:h2:/databases/task-db \
  -e APP_SAMPLE_CONFIG=ValueFromDockerRun \
  -v "$(pwd)/../databases":/databases \
  sample-openliberty:0.1.0-SNAPSHOT
~~~

## URLs

- http://localhost:8080/

~~~
$ curl 'http://localhost:8080/app/rest/sample/time' -i
$ curl 'http://localhost:8080/app/rest/sample/config' -i
$ curl 'http://localhost:8080/app/rest/sample/echo-xml' -i -X POST \
  -H 'content-type: text/xml' \
  -d '<EchoRequest><input>This is CURL</input></EchoRequest>'
$ curl 'http://localhost:8080/app/rest/sample/echo-json' -i -X POST \
  -H 'content-type: application/json' \
  -d '{"input":"This is CURL"}'
$ curl 'http://localhost:8080/app/rest/tasks' -i
$ curl 'http://localhost:8080/app/rest/tasks' -i -X POST \
  -H 'content-type: application/json' \
  -d '{"title":"Some task","description":"This is CURL","done":true}'
$ curl 'http://localhost:8080/app/rest/tasks/5b89f266-c566-4d1f-8545-451bc443cf26' -i
$ curl 'http://localhost:8080/app/rest/tasks/5b89f266-c566-4d1f-8545-451bc443cf26' -i -X PUT \
  -H 'content-type: application/json' \
  -d '{"title":"Some updated task","description":"This is still CURL","done":false}'
$ curl 'http://localhost:8080/app/rest/tasks/5b89f266-c566-4d1f-8545-451bc443cf26' -i -X DELETE
~~~

## TLS (specify custom p12 file)

Notes:

- Use `openssl pkcs12` with `-chain` for CA-signed certs
- For `mvn liberty:run`, add boostrap property `<app.cert.location>${project.basedir}/certs/sample.p12</app.cert.location>`
- For `docker run`, add `-e APP_CERT_LOCATION="/certs/sample.p12"` and `-v "$(pwd)/certs":/certs:ro`
- The file `/config/configDropins/defaults/keystore.xml` is generated by the entrypoint script. 
  It will contain a conflicting password (can be ignored).
  This conflict can be prevented by setting `KEYSTORE_REQUIRED=false` (TODO: does work, seems to be ignored).

~~~
$ mkdir certs
$ cd certs
$ openssl req -newkey rsa:4096 -nodes -sha256 -keyout sample.key -x509 -days 365 -out sample.crt
$ openssl pkcs12 -export -out sample.p12 -passout pass:mypassword -inkey sample.key -in sample.crt
$ chmod 664 sample.p12
~~~

~~~
$ keytool -list -v -keystore certs/sample.p12 -storepass mypassword
$ docker run -it --name sample-openliberty --rm \
  -p 8080:8080 \
  -p 8443:8443 \
  -e APP_CERT_LOCATION="/certs/sample.p12" \
  -e APP_JDBC_URL=jdbc:h2:/databases/task-db \
  -e APP_SAMPLE_CONFIG=ValueFromDockerRun \
  -v "$(pwd)/certs":/certs:ro \
  -v "$(pwd)/../databases":/databases \
  sample-openliberty:0.1.0-SNAPSHOT
~~~

~~~
$ curl 'https://localhost:8443' -v -i --insecure
~~~

## TLS (mount tls.key and tls.crt files)

According to `/opt/ol/helpers/runtime/docker-server.sh`, an existing certificate would be picked up
from `/etc/x509/certs/tls.key` and `/etc/x509/certs/tls.crt` (TODO: fails, container exits).

~~~
$ docker run -it --name sample-openliberty --rm \
  -p 8080:8080 \
  -p 8443:8443 \
  -e APP_JDBC_URL=jdbc:h2:/databases/task-db \
  -e APP_SAMPLE_CONFIG=ValueFromDockerRun \
  -v "$(pwd)/certs/sample.key":/etc/x509/certs/tls.key:ro \
  -v "$(pwd)/certs/sample.crt":/etc/x509/certs/tls.crt:ro \
  -v "$(pwd)/../databases":/databases \
  sample-openliberty:0.1.0-SNAPSHOT
~~~
